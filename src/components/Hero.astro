---
interface Props {
    badge?: string;
    titleLine1?: string;
    titleLine2?: string;
    subtitle?: string;
    floatingStats?: Array<{
        value: string;
        label: string;
    }>;
}

const {
    badge = 'AlphaGrade — B2B Sales Intelligence',
    titleLine1 = 'Pipeline B2B de <strong>€250K+</strong>',
    titleLine2 = 'în 90 de zile.',
    subtitle = 'Identificăm decision-makers cu buget. Inițiem conversații calificate. Livrăm meetings cu VP+ din companii €10M+ revenue. Apollo.io + execuție la cheie.',
    floatingStats = [
        { value: '+89%', label: 'Reply Rate' },
        { value: '€2.3M', label: 'Pipeline' },
        { value: '14 zile', label: 'Time to Close' }
    ]
} = Astro.props;
---

<section class="hero" id="hero">
    <div class="hero-bg">
        <div class="grid-lines"></div>
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
        <canvas id="network-canvas"></canvas>

        <!-- Floating Stats Badges -->
        <div class="floating-stat floating-stat-1">
            <div class="floating-stat-value">{floatingStats[0]?.value}</div>
            <div class="floating-stat-label">{floatingStats[0]?.label}</div>
        </div>
        <div class="floating-stat floating-stat-2">
            <div class="floating-stat-value">{floatingStats[1]?.value}</div>
            <div class="floating-stat-label">{floatingStats[1]?.label}</div>
        </div>
        <div class="floating-stat floating-stat-3">
            <div class="floating-stat-value">{floatingStats[2]?.value}</div>
            <div class="floating-stat-label">{floatingStats[2]?.label}</div>
        </div>
    </div>

    <div class="hero-content">
        <div class="hero-label">{badge}</div>
        <h1 class="hero-title">
            <span class="line"><span set:html={titleLine1} /></span>
            <span class="line"><span class="gradient">{titleLine2}</span></span>
        </h1>
        <p class="hero-sub">{subtitle}</p>
    </div>

    <!-- Hero Audit Form -->
    <div class="hero-audit-form">
        <div class="audit-form-container">
            <div class="audit-form-label">
                <h3>Solicită Audit Gratuit</h3>
                <p>Analizăm potențialul tău de lead generation în 24h</p>
            </div>
            <div class="audit-form-wrapper">
                <form class="audit-form" id="auditForm">
                    <div class="audit-form-field">
                        <input type="url" name="website" placeholder="Website-ul tău" required>
                        <span class="audit-form-field-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="2" y1="12" x2="22" y2="12"/>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                            </svg>
                        </span>
                    </div>
                    <div class="audit-form-field">
                        <input type="tel" name="phone" placeholder="Telefon" required>
                        <span class="audit-form-field-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                            </svg>
                        </span>
                    </div>
                    <div class="audit-form-field">
                        <input type="email" name="email" placeholder="Email" required>
                        <span class="audit-form-field-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                        </span>
                    </div>
                    <button type="submit" class="audit-form-submit">
                        Trimite
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                    </button>
                </form>
                <div class="audit-form-success" id="auditFormSuccess">
                    <div class="success-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                    </div>
                    <div class="success-text">
                        <span class="success-title">Mulțumim!</span>
                        <span class="success-subtitle">Te vom contacta în curând.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    // Network Canvas Animation
    const canvas = document.getElementById('network-canvas') as HTMLCanvasElement;
    if (canvas) {
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener('resize', resize);

        const particles: Array<{x: number; y: number; vx: number; vy: number}> = [];
        const particleCount = 50;

        for (let i = 0; i < particleCount; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                vx: (Math.random() - 0.5) * 0.5,
                vy: (Math.random() - 0.5) * 0.5
            });
        }

        function animate() {
            if (!ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            particles.forEach((p, i) => {
                p.x += p.vx;
                p.y += p.vy;

                if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
                if (p.y < 0 || p.y > canvas.height) p.vy *= -1;

                // Draw particle
                ctx.beginPath();
                ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(99, 102, 241, 0.5)';
                ctx.fill();

                // Draw connections
                particles.slice(i + 1).forEach(p2 => {
                    const dx = p.x - p2.x;
                    const dy = p.y - p2.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < 150) {
                        ctx.beginPath();
                        ctx.moveTo(p.x, p.y);
                        ctx.lineTo(p2.x, p2.y);
                        ctx.strokeStyle = `rgba(99, 102, 241, ${0.2 * (1 - dist / 150)})`;
                        ctx.stroke();
                    }
                });
            });

            requestAnimationFrame(animate);
        }
        animate();
    }

    // Form submission to Pipedrive
    const auditForm = document.getElementById('auditForm') as HTMLFormElement;
    const auditFormSuccess = document.getElementById('auditFormSuccess');
    const submitBtn = auditForm?.querySelector('button[type="submit"]') as HTMLButtonElement;
    const originalBtnText = submitBtn?.innerHTML;

    auditForm?.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Disable button and show loading
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
                <svg class="spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="width:18px;height:18px;animation:spin 1s linear infinite">
                    <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>
                    <path d="M12 2a10 10 0 0 1 10 10" stroke-opacity="1"/>
                </svg>
                Se trimite...
            `;
        }

        const formData = new FormData(auditForm);
        const data = {
            email: formData.get('email'),
            phone: formData.get('phone'),
            website: formData.get('website')
        };

        try {
            const response = await fetch('/api/pipedrive', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok && result.success) {
                // Success - show confirmation
                auditForm.classList.add('hidden');
                auditFormSuccess?.classList.add('visible');
            } else {
                throw new Error(result.error || 'Eroare la trimitere');
            }
        } catch (error) {
            // Reset button on error
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
            alert('A apărut o eroare. Te rugăm să încerci din nou sau să ne contactezi direct.');
            console.error('Form error:', error);
        }
    });
</script>

<style>
    .audit-form-wrapper {
        position: relative;
        min-height: 60px;
    }

    .audit-form.hidden {
        opacity: 0;
        visibility: hidden;
        position: absolute;
        pointer-events: none;
    }

    .audit-form-success {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        padding: 1rem 2rem;
        opacity: 0;
        visibility: hidden;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        transition: all 0.3s ease;
    }

    .audit-form-success.visible {
        opacity: 1;
        visibility: visible;
        position: relative;
    }

    .audit-form-success .success-icon {
        width: 48px;
        height: 48px;
        background: rgba(34, 197, 94, 0.15);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .audit-form-success .success-icon svg {
        width: 24px;
        height: 24px;
        color: var(--green);
    }

    .audit-form-success .success-text {
        display: flex;
        flex-direction: column;
    }

    .audit-form-success .success-title {
        font-family: 'Space Grotesk', sans-serif;
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--green);
    }

    .audit-form-success .success-subtitle {
        font-size: 0.85rem;
        color: var(--gray-400);
    }

    @media (max-width: 900px) {
        .audit-form-wrapper {
            min-height: auto;
        }

        .audit-form-success {
            position: relative;
            padding: 1.5rem;
        }

        .audit-form-success.visible {
            position: relative;
        }
    }
</style>
